#!/usr/bin/env python3
"""
PDF to Knowledge Base Converter
‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡πÄ‡∏õ‡πá‡∏ô JavaScript Knowledge Base ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI Chatbot
"""

import pdfplumber
import json
import sys
import re
from pathlib import Path

def extract_text_from_pdf(pdf_path):
    """‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å PDF"""
    text_content = []
    
    try:
        with pdfplumber.open(pdf_path) as pdf:
            print(f"üìÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô PDF: {pdf_path}")
            print(f"üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤: {len(pdf.pages)}")
            
            for i, page in enumerate(pdf.pages, 1):
                text = page.extract_text()
                if text:
                    text_content.append({
                        'page': i,
                        'content': text.strip()
                    })
                    print(f"‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ {i} ‡πÄ‡∏™‡∏£‡πá‡∏à ({len(text)} ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)")
                    
        return text_content
    except Exception as e:
        print(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
        return None

def parse_zodiac_content(text_content):
    """
    ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å PDF ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Knowledge Base
    ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏° format ‡∏Ç‡∏≠‡∏á PDF ‡∏Ñ‡∏∏‡∏ì
    """
    knowledge = {}
    
    # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ PDF ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
    # ‡∏£‡∏≤‡∏®‡∏µ‡πÄ‡∏°‡∏©
    # ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å: ...
    # ‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô: ...
    
    current_zodiac = None
    current_section = None
    
    for page_data in text_content:
        content = page_data['content']
        lines = content.split('\n')
        
        for line in lines:
            line = line.strip()
            if not line:
                continue
            
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏®‡∏µ
            zodiac_names = ['‡πÄ‡∏°‡∏©', '‡∏û‡∏§‡∏©‡∏†', '‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é', '‡∏™‡∏¥‡∏á‡∏´‡πå', '‡∏Å‡∏±‡∏ô‡∏¢‡πå', 
                          '‡∏ï‡∏∏‡∏•‡∏¢‡πå', '‡∏û‡∏¥‡∏à‡∏¥‡∏Å', '‡∏ò‡∏ô‡∏π', '‡∏°‡∏±‡∏á‡∏Å‡∏£', '‡∏Å‡∏∏‡∏°‡∏†‡πå', '‡∏°‡∏µ‡∏ô']
            
            for zodiac in zodiac_names:
                if zodiac in line:
                    current_zodiac = zodiac
                    if current_zodiac not in knowledge:
                        knowledge[current_zodiac] = {}
                    break
            
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
            if current_zodiac:
                if '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å' in line or '‡∏£‡∏±‡∏Å' in line:
                    current_section = 'love'
                elif '‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô' in line or '‡∏á‡∏≤‡∏ô' in line:
                    current_section = 'career'
                elif '‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô' in line or '‡πÄ‡∏á‡∏¥‡∏ô' in line:
                    current_section = 'finance'
                elif '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' in line:
                    current_section = 'health'
                
                # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                if current_section and len(line) > 20:  # ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£
                    if current_section not in knowledge[current_zodiac]:
                        knowledge[current_zodiac][current_section] = []
                    knowledge[current_zodiac][current_section].append(line)
    
    return knowledge

def convert_to_javascript(knowledge, output_file):
    """‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô JavaScript format"""
    
    js_content = """// Auto-generated Knowledge Base from PDF
// Generated by pdf_to_knowledge.py

const pdfKnowledge = """
    
    # ‡πÅ‡∏õ‡∏•‡∏á dict ‡πÄ‡∏õ‡πá‡∏ô JSON
    js_content += json.dumps(knowledge, ensure_ascii=False, indent=4)
    
    js_content += """;

// Helper function to get knowledge
function getKnowledgeByZodiac(zodiacName) {
    return pdfKnowledge[zodiacName] || null;
}

// Export
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { pdfKnowledge, getKnowledgeByZodiac };
}
"""
    
    # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(js_content)
    
    print(f"\n‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå {output_file} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!")
    return True

def main():
    if len(sys.argv) < 2:
        print("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå PDF")
        print(f"‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: python {sys.argv[0]} <‡πÑ‡∏ü‡∏•‡πå.pdf>")
        print(f"‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: python {sys.argv[0]} zodiac_data.pdf")
        sys.exit(1)
    
    pdf_path = sys.argv[1]
    
    if not Path(pdf_path).exists():
        print(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå: {pdf_path}")
        sys.exit(1)
    
    # ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å PDF
    print("\nüöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå...")
    text_content = extract_text_from_pdf(pdf_path)
    
    if not text_content:
        print("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å PDF ‡πÑ‡∏î‡πâ")
        sys.exit(1)
    
    # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)
    raw_output = "pdf_raw_text.json"
    with open(raw_output, 'w', encoding='utf-8') as f:
        json.dump(text_content, f, ensure_ascii=False, indent=2)
    print(f"\nüíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà: {raw_output}")
    
    # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Knowledge Base
    print("\nüîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Knowledge Base...")
    knowledge = parse_zodiac_content(text_content)
    
    if not knowledge:
        print("‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏î‡πâ")
        print("üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö pdf_raw_text.json ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô parse_zodiac_content()")
        sys.exit(1)
    
    # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô JavaScript
    output_file = "../js/data/pdf-knowledge.js"
    convert_to_javascript(knowledge, output_file)
    
    print(f"\nüìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥:")
    print(f"   - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏®‡∏µ: {len(knowledge)}")
    for zodiac, data in knowledge.items():
        print(f"   - {zodiac}: {len(data)} ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠")
    
    print("\n‚ú® ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
    print(f"üìÅ ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á: {output_file}")
    print("\nüí° ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ:")
    print("   1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå js/data/pdf-knowledge.js")
    print("   2. ‡πÄ‡∏û‡∏¥‡πà‡∏° <script src='js/data/pdf-knowledge.js'></script> ‡πÉ‡∏ô chatbot.html")
    print("   3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó chatbot.js ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å pdfKnowledge")

if __name__ == "__main__":
    main()
